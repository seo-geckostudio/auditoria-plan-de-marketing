<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema IA Local - Ollama Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -30px -30px 30px -30px;
        }
        .test-result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .test-result.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .test-result.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .test-result.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .test-result.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .badge-custom {
            font-size: 0.9em;
            padding: 5px 10px;
        }
        .iframe-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        iframe {
            width: 100%;
            height: 800px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-card">
            <div class="test-header">
                <h1><i class="fas fa-robot"></i> Test: Sistema IA Local con Ollama</h1>
                <p class="mb-0">Prueba de integraci√≥n completa con preview detallado</p>
            </div>

            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Objetivo del Test</h5>
                <p class="mb-0">Verificar que el sistema IA Local funciona correctamente con:</p>
                <ul class="mb-0 mt-2">
                    <li>‚úÖ Detecci√≥n de Ollama (100% Local)</li>
                    <li>‚úÖ Detecci√≥n de Claude CLI (opcional)</li>
                    <li>‚úÖ Detecci√≥n de Gemini CLI (opcional)</li>
                    <li>‚úÖ Selector de modelos para Ollama</li>
                    <li>‚úÖ Preview detallado ANTES de insertar datos</li>
                    <li>‚úÖ Indicaci√≥n clara de qu√© CLI se est√° usando</li>
                </ul>
            </div>

            <div id="test-results">
                <h5><i class="fas fa-vial"></i> Resultados de Pruebas</h5>
                <button class="btn btn-primary mb-3" onclick="ejecutarTests()">
                    <i class="fas fa-play"></i> Ejecutar Tests
                </button>
                <div id="resultados-tests"></div>
            </div>

            <hr>

            <h5><i class="fas fa-globe"></i> Vista del Formulario Real</h5>
            <p class="text-muted">El formulario se cargar√° a continuaci√≥n. Haz clic en "Asistencia con Inteligencia Artificial" para probar.</p>

            <div class="iframe-container">
                <iframe id="formulario-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tests automatizados
        async function ejecutarTests() {
            const resultadosDiv = document.getElementById('resultados-tests');
            resultadosDiv.innerHTML = '<p class="text-muted">Ejecutando tests...</p>';

            const tests = [];

            // Test 1: Detectar CLIs disponibles
            try {
                const response = await fetch('api/detectar_cli_ia.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({clientes: ['ollama', 'claude', 'gemini']})
                });
                const data = await response.json();

                tests.push({
                    nombre: 'Detecci√≥n de CLIs',
                    resultado: data.disponibles && Object.keys(data.disponibles).length > 0 ? 'success' : 'warning',
                    mensaje: data.disponibles ?
                        `‚úÖ Detectadas: ${Object.keys(data.disponibles).join(', ')}` :
                        '‚ö†Ô∏è No se detectaron CLIs',
                    detalles: data
                });

                // Test 1.1: Verificar Ollama espec√≠ficamente
                if (data.disponibles && data.disponibles.ollama) {
                    tests.push({
                        nombre: 'Ollama (100% Local)',
                        resultado: 'success',
                        mensaje: `‚úÖ Ollama v${data.disponibles.ollama.version} - ${data.disponibles.ollama.modelos?.length || 0} modelos`,
                        detalles: data.disponibles.ollama
                    });
                } else {
                    tests.push({
                        nombre: 'Ollama (100% Local)',
                        resultado: 'error',
                        mensaje: '‚ùå Ollama no detectado - Instala con: https://ollama.com/',
                        detalles: null
                    });
                }

                // Test 1.2: Verificar Claude CLI
                if (data.disponibles && data.disponibles.claude) {
                    tests.push({
                        nombre: 'Claude CLI',
                        resultado: data.disponibles.claude.configurado ? 'success' : 'warning',
                        mensaje: data.disponibles.claude.configurado ?
                            `‚úÖ Claude CLI v${data.disponibles.claude.version} - Configurado` :
                            `‚ö†Ô∏è Claude CLI detectado pero no configurado`,
                        detalles: data.disponibles.claude
                    });
                }

                // Test 1.3: Verificar Gemini CLI
                if (data.disponibles && data.disponibles.gemini) {
                    tests.push({
                        nombre: 'Gemini CLI',
                        resultado: data.disponibles.gemini.configurado ? 'success' : 'warning',
                        mensaje: data.disponibles.gemini.configurado ?
                            `‚úÖ Gemini CLI v${data.disponibles.gemini.version} - Configurado` :
                            `‚ö†Ô∏è Gemini CLI detectado pero no configurado`,
                        detalles: data.disponibles.gemini
                    });
                }

            } catch (error) {
                tests.push({
                    nombre: 'Detecci√≥n de CLIs',
                    resultado: 'error',
                    mensaje: '‚ùå Error al detectar CLIs: ' + error.message,
                    detalles: error
                });
            }

            // Test 2: Verificar que scripts existen
            const scriptsToCheck = [
                'js/ia_local_integration.js',
                'js/brief_cliente_import.js'
            ];

            for (const script of scriptsToCheck) {
                try {
                    const response = await fetch(script);
                    tests.push({
                        nombre: `Script: ${script}`,
                        resultado: response.ok ? 'success' : 'error',
                        mensaje: response.ok ? '‚úÖ Script cargado' : '‚ùå Script no encontrado',
                        detalles: {status: response.status}
                    });
                } catch (error) {
                    tests.push({
                        nombre: `Script: ${script}`,
                        resultado: 'error',
                        mensaje: '‚ùå Error al cargar: ' + error.message,
                        detalles: error
                    });
                }
            }

            // Test 3: Verificar estructura HTML en iframe
            tests.push({
                nombre: 'Carga del Formulario',
                resultado: 'info',
                mensaje: 'üìã Carga el iframe para probar manualmente',
                detalles: {url: 'http://localhost:8000/?modulo=auditorias&accion=formulario&auditoria_id=30&paso_id=968'}
            });

            // Renderizar resultados
            mostrarResultados(tests);
        }

        function mostrarResultados(tests) {
            const resultadosDiv = document.getElementById('resultados-tests');
            let html = '';

            const totalTests = tests.length;
            const exitosos = tests.filter(t => t.resultado === 'success').length;
            const fallidos = tests.filter(t => t.resultado === 'error').length;
            const advertencias = tests.filter(t => t.resultado === 'warning').length;

            html += `
                <div class="alert alert-${exitosos === totalTests ? 'success' : (fallidos > 0 ? 'danger' : 'warning')} mb-3">
                    <strong>Resumen:</strong> ${exitosos}/${totalTests} tests OK
                    ${fallidos > 0 ? `| ${fallidos} errores` : ''}
                    ${advertencias > 0 ? `| ${advertencias} advertencias` : ''}
                </div>
            `;

            tests.forEach(test => {
                html += `
                    <div class="test-result ${test.resultado}">
                        <div>
                            <strong>${test.nombre}:</strong> ${test.mensaje}
                            ${test.detalles ? `<br><small class="text-muted">Detalles: ${JSON.stringify(test.detalles).substring(0, 100)}...</small>` : ''}
                        </div>
                        <span class="badge bg-${
                            test.resultado === 'success' ? 'success' :
                            test.resultado === 'error' ? 'danger' :
                            test.resultado === 'warning' ? 'warning' : 'info'
                        } badge-custom">
                            ${test.resultado === 'success' ? '‚úÖ OK' :
                              test.resultado === 'error' ? '‚ùå ERROR' :
                              test.resultado === 'warning' ? '‚ö†Ô∏è WARN' : '‚ÑπÔ∏è INFO'}
                        </span>
                    </div>
                `;
            });

            resultadosDiv.innerHTML = html;
        }

        // Cargar iframe al inicio
        window.addEventListener('load', () => {
            document.getElementById('formulario-iframe').src =
                'http://localhost:8000/?modulo=auditorias&accion=formulario&auditoria_id=30&paso_id=968';
        });
    </script>
</body>
</html>
